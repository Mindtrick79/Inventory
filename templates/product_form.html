{% extends 'base.html' %}
{% block content %}
<h2>Add Product</h2>
<form method="post" enctype="multipart/form-data">
  <div>
    <label for="product_name">Product Name</label>
    <input type="text" id="product_name" name="product_name" required>
  </div>

  <div>
    <label for="category">Category</label>
    <input type="text" id="category" name="category">
  </div>

  <div>
    <label for="quantity_on_hand">Quantity on Hand</label>
    <input type="number" step="1" min="0" id="quantity_on_hand" name="quantity_on_hand" required>
  </div>

  <div>
    <label for="container_unit">Container Unit</label>
    <select id="container_unit" name="container_unit">
      <option value="">-- Select unit --</option>
      {% for u in container_units %}
        <option value="{{ u }}">{{ u }}</option>
      {% endfor %}
      <option value="__other__">Other...</option>
    </select>
    <input type="text" id="container_unit_other" name="container_unit_other" placeholder="Enter unit" style="display:none; margin-left:0.5rem;">
  </div>

  <div>
    <label for="reorder_threshold">Reorder Threshold</label>
    <input type="number" step="1" min="0" id="reorder_threshold" name="reorder_threshold">
  </div>

  <div>
    <label for="reorder_amount">Reorder Amount</label>
    <input type="number" step="1" min="0" id="reorder_amount" name="reorder_amount">
  </div>

  <div>
    <label for="reorder_quantity">Reorder Quantity (label)</label>
    <select id="reorder_quantity" name="reorder_quantity">
      <option value="">-- Select label --</option>
      {% for lbl in reorder_labels %}
        <option value="{{ lbl }}">{{ lbl }}</option>
      {% endfor %}
      <option value="__other__">Other...</option>
    </select>
    <input type="text" id="reorder_quantity_other" name="reorder_quantity_other" placeholder="Enter label" style="display:none; margin-left:0.5rem;">
  </div>

  <div>
    <label for="distributor">Distributor</label>
    <select id="distributor" name="distributor">
      <option value="">-- Select distributor --</option>
      {% for d in distributors %}
        <option value="{{ d }}">{{ d }}</option>
      {% endfor %}
      <option value="__other__">Other...</option>
    </select>
    <input type="text" id="distributor_other" name="distributor_other" placeholder="Enter distributor" style="display:none; margin-left:0.5rem;">
  </div>

  <div>
    <label for="location">Location</label>
    <input type="text" id="location" name="location" placeholder="Shop, Truck 1, etc.">
    <label for="cost_per_unit">Cost Per Unit</label>
    <input type="text" id="cost_per_unit" name="cost_per_unit" placeholder="e.g. 12.50">
  </div>

  <div>
    <label for="epa_reg_no">EPA Registration Number</label>
    <input type="text" id="epa_reg_no" name="epa_reg_no" placeholder="e.g. 12345-678">
  </div>

  <div>
    <label for="epa_est_no">EPA Establishment Number</label>
    <input type="text" id="epa_est_no" name="epa_est_no" placeholder="e.g. 98765-TX-1">
  </div>

  <div>
    <label for="product_image">Product Image (optional)</label>
    <input type="file" id="product_image" name="product_image" accept="image/png,image/jpeg,image/gif,image/webp" capture="environment">
    <div class="form-actions" style="margin-top:0.5rem;">
      <button type="button" id="camera_open_btn">Use Camera</button>
      <button type="button" id="camera_clear_btn">Clear Image</button>
    </div>
    <div id="camera_status" style="margin-top:0.5rem;"></div>
  </div>

  <div>
    <button type="submit">Save</button>
    <a href="{{ url_for('products') }}">Cancel</a>
  </div>
</form>
<script>
  function toggleOther(selectId, otherInputId) {
    var sel = document.getElementById(selectId);
    var other = document.getElementById(otherInputId);
    if (!sel || !other) return;
    if (sel.value === "__other__") {
      other.style.display = "inline-block";
      other.focus();
    } else {
      other.style.display = "none";
      other.value = "";
    }
  }

  document.getElementById('container_unit').addEventListener('change', function() {
    toggleOther('container_unit', 'container_unit_other');
  });
  document.getElementById('reorder_quantity').addEventListener('change', function() {
    toggleOther('reorder_quantity', 'reorder_quantity_other');
  });
  document.getElementById('distributor').addEventListener('change', function() {
    toggleOther('distributor', 'distributor_other');
  });

  (function initCameraCapture() {
    var input = document.getElementById('product_image');
    var openBtn = document.getElementById('camera_open_btn');
    var clearBtn = document.getElementById('camera_clear_btn');
    var statusEl = document.getElementById('camera_status');

    if (!input || !openBtn || !clearBtn) return;

    function setStatus(msg) {
      if (!statusEl) return;
      statusEl.textContent = msg || '';
    }

    function clearImage() {
      try {
        input.value = '';
        setStatus('');
      } catch (e) {
        setStatus('Unable to clear image.');
      }
    }

    clearBtn.addEventListener('click', function() {
      clearImage();
    });

    function stopStream(stream) {
      try {
        if (stream) {
          stream.getTracks().forEach(function(t) { t.stop(); });
        }
      } catch (e) {
      }
    }

    function ensureModal() {
      var existing = document.getElementById('camera_modal');
      if (existing) return existing;

      var modal = document.createElement('div');
      modal.id = 'camera_modal';
      modal.className = 'camera-modal';
      modal.innerHTML = '' +
        '<div class="camera-modal__panel">' +
          '<div class="camera-modal__header">' +
            '<div class="camera-modal__title">Take Photo</div>' +
            '<button type="button" class="camera-modal__close" id="camera_close_btn">Close</button>' +
          '</div>' +
          '<div class="camera-modal__body">' +
            '<video id="camera_video" autoplay playsinline></video>' +
            '<canvas id="camera_canvas" style="display:none;"></canvas>' +
          '</div>' +
          '<div class="camera-modal__actions">' +
            '<button type="button" id="camera_snap_btn">Snap</button>' +
            '<button type="button" id="camera_use_btn" disabled>Use Photo</button>' +
          '</div>' +
          '<div class="camera-modal__hint" id="camera_hint"></div>' +
        '</div>';

      document.body.appendChild(modal);
      return modal;
    }

    openBtn.addEventListener('click', async function() {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        setStatus('Camera is not supported in this browser. Use the file picker to upload.');
        input.click();
        return;
      }

      var modal = ensureModal();
      var closeBtn = document.getElementById('camera_close_btn');
      var video = document.getElementById('camera_video');
      var canvas = document.getElementById('camera_canvas');
      var snapBtn = document.getElementById('camera_snap_btn');
      var useBtn = document.getElementById('camera_use_btn');
      var hint = document.getElementById('camera_hint');

      var activeStream = null;
      var lastBlob = null;
      useBtn.disabled = true;
      if (hint) hint.textContent = '';

      function close() {
        modal.classList.remove('camera-modal--open');
        stopStream(activeStream);
        activeStream = null;
        lastBlob = null;
        useBtn.disabled = true;
      }

      if (closeBtn) {
        closeBtn.onclick = close;
      }
      modal.addEventListener('click', function(e) {
        if (e.target === modal) close();
      });

      try {
        activeStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: { ideal: 'environment' } }, audio: false });
        if (video) {
          video.srcObject = activeStream;
        }
        modal.classList.add('camera-modal--open');
      } catch (e) {
        setStatus('Camera permission denied or unavailable. Use the file picker to upload.');
        input.click();
        return;
      }

      snapBtn.onclick = function() {
        if (!video || !canvas) return;
        var w = video.videoWidth || 1280;
        var h = video.videoHeight || 720;
        canvas.width = w;
        canvas.height = h;
        var ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0, w, h);
        canvas.toBlob(function(blob) {
          lastBlob = blob;
          useBtn.disabled = !blob;
          if (hint) hint.textContent = blob ? 'Photo captured. Click “Use Photo”.' : 'Failed to capture photo.';
        }, 'image/jpeg', 0.9);
      };

      useBtn.onclick = function() {
        if (!lastBlob) return;
        var file = new File([lastBlob], 'camera_photo.jpg', { type: 'image/jpeg' });
        try {
          var dt = new DataTransfer();
          dt.items.add(file);
          input.files = dt.files;
          setStatus('Camera photo selected.');
        } catch (e) {
          setStatus('Camera photo captured, but browser could not attach it. Please use upload instead.');
        }
        close();
      };
    });
  })();
</script>
{% endblock %}
