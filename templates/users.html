{% extends 'base.html' %}
{% block content %}

<div class="page-toolbar">
  <div class="page-toolbar__title">
    <h2>User Management</h2>
    <div class="page-toolbar__subtitle">Admin-only: manage application users, roles, and passwords.</div>
  </div>
  <div class="page-toolbar__actions">
    <a class="btn btn--secondary" href="{{ url_for('account_requests_view') }}">Account Requests</a>
    <a class="btn btn--secondary" href="{{ url_for('index') }}">Dashboard</a>
  </div>
</div>

<section>
  <h3>Existing Users</h3>
  {% if users %}
  <div class="table-wrap">
  <table>
    <thead>
      <tr>
        <th>Username</th>
        <th>Role</th>
        <th>Name</th>
        <th>License #</th>
        <th>Photo</th>
        <th>Phone</th>
        <th>Email</th>
        <th>Default Truck</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for u in users %}
      <tr>
        <td>{{ u.username }}</td>
        <td>
          {% if u.role %}
            <span class="status-badge status-{{ u.role }}">{{ u.role }}</span>
          {% endif %}
        </td>
        <td>{{ u.display_name }}</td>
        <td>{{ u.license_number }}</td>
        <td>
          {% if u.photo_path %}
            <img src="{{ url_for('static', filename=u.photo_path) }}" alt="Photo" style="max-height: 48px; border-radius: 4px;">
          {% endif %}
        </td>
        <td>{{ u.phone }}</td>
        <td>{{ u.email }}</td>
        <td>{{ u.default_truck }}</td>
        <td>
          <button class="btn btn--secondary btn--sm" type="button" onclick="editUser('{{ u.username }}', '{{ u.role }}', '{{ u.display_name }}', '{{ u.license_number }}', '{{ u.phone }}', '{{ u.email }}', '{{ u.default_truck }}')">Edit</button>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  </div>
  {% else %}
    <div class="empty-state">
      <div class="empty-state__title">No users found</div>
      <div class="empty-state__hint">Create the first user below.</div>
    </div>
  {% endif %}
</section>

<section>
  <h3>Add / Update User</h3>
  <form method="post" enctype="multipart/form-data">
    <div class="form-card">
      <div class="form-card__title">User details</div>
      <div class="form-grid">
        <div class="form-field">
          <label for="username">Username</label>
          <input type="text" id="username" name="username" required>
        </div>
        <div class="form-field">
          <label for="display_name">Name</label>
          <input type="text" id="display_name" name="display_name" placeholder="Technician name">
        </div>
        <div class="form-field">
          <label for="license_number">License #</label>
          <input type="text" id="license_number" name="license_number" placeholder="State license number">
        </div>
        <div class="form-field">
          <label for="phone">Phone</label>
          <input type="text" id="phone" name="phone" placeholder="Cell phone">
        </div>
        <div class="form-field">
          <label for="email">Email</label>
          <input type="text" id="email" name="email" placeholder="Optional">
        </div>
        <div class="form-field">
          <label for="default_truck">Default Truck</label>
          <input type="text" id="default_truck" name="default_truck" placeholder="Truck 1, Truck 2, etc.">
        </div>
        <div class="form-field">
          <label for="role">Role</label>
          <select id="role" name="role">
            {% for r in roles %}
              <option value="{{ r }}">{{ r }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="form-field">
          <label for="photo">Headshot Photo</label>
          <input type="file" id="photo" name="photo" accept="image/*">
        </div>
        <div class="form-field">
          <label for="password">Password (leave blank to keep existing)</label>
          <input type="password" id="password" name="password">
        </div>
      </div>
      <div class="form-actions">
        <button class="btn btn--primary" type="submit">Save User</button>
      </div>
    </div>
  </form>
</section>

<script>
  function editUser(username, role, displayName, licenseNumber, phone, email, defaultTruck) {
    var uInput = document.getElementById('username');
    var displayNameInput = document.getElementById('display_name');
    var licenseNumberInput = document.getElementById('license_number');
    var phoneInput = document.getElementById('phone');
    var emailInput = document.getElementById('email');
    var defaultTruckInput = document.getElementById('default_truck');
    var roleSelect = document.getElementById('role');
    if (uInput) {
      uInput.value = username;
    }
    if (displayNameInput) {
      displayNameInput.value = displayName || '';
    }
    if (licenseNumberInput) {
      licenseNumberInput.value = licenseNumber || '';
    }
    if (phoneInput) {
      phoneInput.value = phone || '';
    }
    if (emailInput) {
      emailInput.value = email || '';
    }
    if (defaultTruckInput) {
      defaultTruckInput.value = defaultTruck || '';
    }
    if (roleSelect) {
      for (var i = 0; i < roleSelect.options.length; i++) {
        if (roleSelect.options[i].value === role) {
          roleSelect.selectedIndex = i;
          break;
        }
      }
    }
    // Scroll form into view on smaller screens
    var form = document.querySelector('form');
    if (form && form.scrollIntoView) {
      form.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  }
</script>

{% endblock %}
