{% extends 'base.html' %}
{% block content %}
<h2>Theme Settings</h2>
<p>Customize colors and fonts for the app. Changes apply to all users.</p>

<form method="post" id="theme-form">
  <fieldset>
    <legend>Presets</legend>
    <div>
      <label for="theme_preset">Theme Preset</label>
      <select id="theme_preset" name="theme_preset">
        <option value="custom" selected>Custom</option>
        <option value="default">Default</option>
        <option value="dark">Dark</option>
        <option value="highcontrast">High Contrast</option>
        <option value="forest">Forest</option>
        <option value="sunset">Sunset</option>
        <option value="slate">Slate</option>
      </select>
    </div>
  </fieldset>
  <fieldset>
    <legend>Layout</legend>
    <div>
      <label for="theme_bg">Page Background</label>
      <input type="color" id="theme_bg" name="theme_bg" value="{{ settings.theme_bg }}">
    </div>
    <div>
      <label for="theme_text">Body Text</label>
      <input type="color" id="theme_text" name="theme_text" value="{{ settings.theme_text or '#111111' }}">
    </div>
    <div>
      <label for="theme_card_bg">Card / Table Background</label>
      <input type="color" id="theme_card_bg" name="theme_card_bg" value="{{ settings.theme_card_bg }}">
    </div>
    <div>
      <label for="theme_radius">Corner Radius</label>
      <select id="theme_radius" name="theme_radius">
        {% set current_radius = settings.theme_radius or '6px' %}
        <option value="0px" {% if current_radius == '0px' %}selected{% endif %}>Square</option>
        <option value="4px" {% if current_radius == '4px' %}selected{% endif %}>Small</option>
        <option value="6px" {% if current_radius == '6px' %}selected{% endif %}>Medium</option>
        <option value="10px" {% if current_radius == '10px' %}selected{% endif %}>Large</option>
        <option value="16px" {% if current_radius == '16px' %}selected{% endif %}>Extra</option>
      </select>
    </div>
    <div>
      <label for="theme_border_width">Border Thickness</label>
      <select id="theme_border_width" name="theme_border_width">
        {% set current_bw = settings.theme_border_width or '1px' %}
        <option value="0px" {% if current_bw == '0px' %}selected{% endif %}>None</option>
        <option value="1px" {% if current_bw == '1px' %}selected{% endif %}>1px</option>
        <option value="2px" {% if current_bw == '2px' %}selected{% endif %}>2px</option>
        <option value="3px" {% if current_bw == '3px' %}selected{% endif %}>3px</option>
      </select>
    </div>
    <div>
      <label for="theme_spacing">Spacing Density</label>
      {% set current_spacing = settings.theme_spacing or '1' %}
      <select id="theme_spacing" name="theme_spacing">
        <option value="0.85" {% if current_spacing == '0.85' %}selected{% endif %}>Compact</option>
        <option value="1" {% if current_spacing == '1' %}selected{% endif %}>Normal</option>
        <option value="1.15" {% if current_spacing == '1.15' %}selected{% endif %}>Comfortable</option>
        <option value="1.3" {% if current_spacing == '1.3' %}selected{% endif %}>Extra</option>
      </select>
    </div>
    <div>
      <label for="theme_header_height">Header Height (optional)</label>
      <input type="text" id="theme_header_height" name="theme_header_height" value="{{ settings.theme_header_height or '' }}" placeholder="e.g. 72px">
    </div>
  </fieldset>

  <fieldset>
    <legend>Header &amp; Navigation</legend>
    <div>
      <label for="theme_header_bg">Header Bar</label>
      <input type="color" id="theme_header_bg" name="theme_header_bg" value="{{ settings.theme_header_bg }}">
    </div>
    <div>
      <label for="theme_header_text">Header Text</label>
      <input type="color" id="theme_header_text" name="theme_header_text" value="{{ settings.theme_header_text }}">
    </div>
    <div>
      <label for="theme_nav_link">Nav Link</label>
      <input type="color" id="theme_nav_link" name="theme_nav_link" value="{{ settings.theme_nav_link }}">
    </div>
    <div>
      <label for="theme_nav_link_hover">Nav Link (Hover)</label>
      <input type="color" id="theme_nav_link_hover" name="theme_nav_link_hover" value="{{ settings.theme_nav_link_hover }}">
    </div>
  </fieldset>

  <fieldset>
    <legend>Tables</legend>
    <div>
      <label for="theme_table_header_bg">Header Row</label>
      <input type="color" id="theme_table_header_bg" name="theme_table_header_bg" value="{{ settings.theme_table_header_bg }}">
    </div>
    <div>
      <label for="theme_table_row_alt">Alternate Row</label>
      <input type="color" id="theme_table_row_alt" name="theme_table_row_alt" value="{{ settings.theme_table_row_alt }}">
    </div>
    <div>
      <label for="theme_table_row_hover">Row Hover</label>
      <input type="color" id="theme_table_row_hover" name="theme_table_row_hover" value="{{ settings.theme_table_row_hover }}">
    </div>
  </fieldset>

  <fieldset>
    <legend>Buttons</legend>
    <div>
      <label for="theme_button_bg">Button Background</label>
      <input type="color" id="theme_button_bg" name="theme_button_bg" value="{{ settings.theme_button_bg }}">
    </div>
    <div>
      <label for="theme_button_hover_bg">Button Hover</label>
      <input type="color" id="theme_button_hover_bg" name="theme_button_hover_bg" value="{{ settings.theme_button_hover_bg }}">
    </div>
    <div>
      <label for="theme_button_text">Button Text</label>
      <input type="color" id="theme_button_text" name="theme_button_text" value="{{ settings.theme_button_text }}">
    </div>
  </fieldset>

  <fieldset>
    <legend>Fonts</legend>
    <div>
      <label for="theme_font_family">Base Font</label>
      <input type="hidden" id="theme_google_font_url" name="theme_google_font_url" value="{{ settings.theme_google_font_url or '' }}">
      <select id="theme_font_family" name="theme_font_family">
        {% set current_font = settings.theme_font_family or 'Arial, sans-serif' %}
        <optgroup label="System Fonts">
        <option value="Arial, sans-serif" {% if current_font == 'Arial, sans-serif' %}selected{% endif %}>Arial</option>
        <option value="'Segoe UI', sans-serif" {% if current_font == "'Segoe UI', sans-serif" %}selected{% endif %}>Segoe UI</option>
        <option value="'Georgia', serif" {% if current_font == "'Georgia', serif" %}selected{% endif %}>Georgia</option>
        <option value="'Tahoma', sans-serif" {% if current_font == "'Tahoma', sans-serif" %}selected{% endif %}>Tahoma</option>
        <option value="'Trebuchet MS', sans-serif" {% if current_font == "'Trebuchet MS', sans-serif" %}selected{% endif %}>Trebuchet MS</option>
        <option value="'Verdana', sans-serif" {% if current_font == "'Verdana', sans-serif" %}selected{% endif %}>Verdana</option>
        <option value="'Times New Roman', serif" {% if current_font == "'Times New Roman', serif" %}selected{% endif %}>Times New Roman</option>
        <option value="'Courier New', monospace" {% if current_font == "'Courier New', monospace" %}selected{% endif %}>Courier New</option>
        <option value="'Consolas', monospace" {% if current_font == "'Consolas', monospace" %}selected{% endif %}>Consolas</option>
        </optgroup>

        <optgroup label="Google Fonts">
          <option value="'Inter', sans-serif" data-google-url="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" {% if current_font == "'Inter', sans-serif" %}selected{% endif %}>Inter (Google)</option>
          <option value="'Roboto', sans-serif" data-google-url="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" {% if current_font == "'Roboto', sans-serif" %}selected{% endif %}>Roboto (Google)</option>
          <option value="'Open Sans', sans-serif" data-google-url="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" {% if current_font == "'Open Sans', sans-serif" %}selected{% endif %}>Open Sans (Google)</option>
          <option value="'Lato', sans-serif" data-google-url="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&display=swap" {% if current_font == "'Lato', sans-serif" %}selected{% endif %}>Lato (Google)</option>
          <option value="'Poppins', sans-serif" data-google-url="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" {% if current_font == "'Poppins', sans-serif" %}selected{% endif %}>Poppins (Google)</option>
          <option value="'Montserrat', sans-serif" data-google-url="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" {% if current_font == "'Montserrat', sans-serif" %}selected{% endif %}>Montserrat (Google)</option>
          <option value="'Source Sans 3', sans-serif" data-google-url="https://fonts.googleapis.com/css2?family=Source+Sans+3:wght@400;600;700&display=swap" {% if current_font == "'Source Sans 3', sans-serif" %}selected{% endif %}>Source Sans 3 (Google)</option>
        </optgroup>
      </select>
    </div>
  </fieldset>

  <div class="form-actions">
    <button type="submit">Save Theme</button>
  </div>
</form>
 
<hr>

<h3>Live Preview</h3>
<div id="theme-preview" style="border: 1px solid #ccc; border-radius: 4px; overflow: hidden; max-width: 480px;">
  <div id="preview-header" style="padding: 0.5rem 0.75rem; font-weight: bold;">Header / Nav Preview</div>
  <div id="preview-body" style="padding: 0.75rem;">
    <div style="margin-bottom: 0.5rem;">
      <a href="#" id="preview-link" style="margin-right: 0.75rem; text-decoration: none;">Link</a>
      <a href="#" id="preview-link-hover" style="text-decoration: underline;">Hover Link</a>
    </div>
    <button type="button" id="preview-button" style="margin-bottom: 0.75rem;">Button</button>
    <table style="width: 100%; border-collapse: collapse; font-size: 0.85rem;">
      <thead>
        <tr id="preview-th-row">
          <th style="padding: 0.25rem 0.4rem; border: 1px solid #ddd;">Header</th>
          <th style="padding: 0.25rem 0.4rem; border: 1px solid #ddd;">Header</th>
        </tr>
      </thead>
      <tbody>
        <tr id="preview-row-alt">
          <td style="padding: 0.25rem 0.4rem; border: 1px solid #ddd;">Row (alt)</td>
          <td style="padding: 0.25rem 0.4rem; border: 1px solid #ddd;">Value</td>
        </tr>
        <tr id="preview-row-hover">
          <td style="padding: 0.25rem 0.4rem; border: 1px solid #ddd;">Row (hover)</td>
          <td style="padding: 0.25rem 0.4rem; border: 1px solid #ddd;">Value</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<script>
  (function () {
    const presets = {
      default: {
        theme_bg: '#f5f5f5',
        theme_text: '#111111',
        theme_card_bg: '#ffffff',
        theme_header_bg: '#1f4e79',
        theme_header_text: '#ffffff',
        theme_nav_link: '#ffffff',
        theme_nav_link_hover: '#ffffff',
        theme_table_header_bg: '#e3edf5',
        theme_table_row_alt: '#fafafa',
        theme_table_row_hover: '#f1f7ff',
        theme_button_bg: '#1f4e79',
        theme_button_hover_bg: '#173958',
        theme_button_text: '#ffffff'
      },
      dark: {
        theme_bg: '#121212',
        theme_text: '#eeeeee',
        theme_card_bg: '#1e1e1e',
        theme_header_bg: '#222831',
        theme_header_text: '#eeeeee',
        theme_nav_link: '#eeeeee',
        theme_nav_link_hover: '#00adb5',
        theme_table_header_bg: '#393e46',
        theme_table_row_alt: '#222831',
        theme_table_row_hover: '#393e46',
        theme_button_bg: '#00adb5',
        theme_button_hover_bg: '#00838a',
        theme_button_text: '#ffffff'
      },
      highcontrast: {
        theme_bg: '#000000',
        theme_text: '#000000',
        theme_card_bg: '#ffffff',
        theme_header_bg: '#000000',
        theme_header_text: '#ffff00',
        theme_nav_link: '#00ffff',
        theme_nav_link_hover: '#ff00ff',
        theme_table_header_bg: '#ffff00',
        theme_table_row_alt: '#ffffff',
        theme_table_row_hover: '#ffe680',
        theme_button_bg: '#000000',
        theme_button_hover_bg: '#333333',
        theme_button_text: '#ffff00'
      },
      forest: {
        theme_bg: '#0b1d14',
        theme_text: '#e7f7ef',
        theme_card_bg: '#12261b',
        theme_header_bg: '#0f2d1e',
        theme_header_text: '#e7f7ef',
        theme_nav_link: '#a8e6cf',
        theme_nav_link_hover: '#dcedc1',
        theme_table_header_bg: '#1c3b2a',
        theme_table_row_alt: '#142c20',
        theme_table_row_hover: '#1c3b2a',
        theme_button_bg: '#2d6a4f',
        theme_button_hover_bg: '#1b4332',
        theme_button_text: '#ffffff'
      },
      sunset: {
        theme_bg: '#fff3e6',
        theme_text: '#2b2b2b',
        theme_card_bg: '#ffffff',
        theme_header_bg: '#ff6b6b',
        theme_header_text: '#ffffff',
        theme_nav_link: '#ffffff',
        theme_nav_link_hover: '#ffe66d',
        theme_table_header_bg: '#ffd6a5',
        theme_table_row_alt: '#ffffff',
        theme_table_row_hover: '#ffe5d9',
        theme_button_bg: '#4d96ff',
        theme_button_hover_bg: '#2f6fd6',
        theme_button_text: '#ffffff'
      },
      slate: {
        theme_bg: '#f1f5f9',
        theme_text: '#0f172a',
        theme_card_bg: '#ffffff',
        theme_header_bg: '#0f172a',
        theme_header_text: '#ffffff',
        theme_nav_link: '#ffffff',
        theme_nav_link_hover: '#38bdf8',
        theme_table_header_bg: '#e2e8f0',
        theme_table_row_alt: '#f8fafc',
        theme_table_row_hover: '#e0f2fe',
        theme_button_bg: '#2563eb',
        theme_button_hover_bg: '#1d4ed8',
        theme_button_text: '#ffffff'
      }
    };

    const fieldIds = [
      'theme_bg',
      'theme_text',
      'theme_card_bg',
      'theme_radius',
      'theme_border_width',
      'theme_spacing',
      'theme_header_height',
      'theme_header_bg',
      'theme_header_text',
      'theme_nav_link',
      'theme_nav_link_hover',
      'theme_table_header_bg',
      'theme_table_row_alt',
      'theme_table_row_hover',
      'theme_button_bg',
      'theme_button_hover_bg',
      'theme_button_text'
    ];

    const $ = (id) => document.getElementById(id);

    function applyPreset(name) {
      const preset = presets[name];
      if (!preset) return;
      fieldIds.forEach((id) => {
        if (preset[id] && $(id)) {
          $(id).value = preset[id];
        }
      });
      updatePreview();
    }

    function updatePreview() {
      const bg = $('theme_bg').value;
      const text = $('theme_text').value;
      const cardBg = $('theme_card_bg').value;
      const radius = $('theme_radius') ? $('theme_radius').value : '6px';
      const borderWidth = $('theme_border_width') ? $('theme_border_width').value : '1px';
      const spacing = $('theme_spacing') ? $('theme_spacing').value : '1';
      const headerHeight = $('theme_header_height') ? $('theme_header_height').value : '';
      const headerBg = $('theme_header_bg').value;
      const headerText = $('theme_header_text').value;
      const navLink = $('theme_nav_link').value;
      const navLinkHover = $('theme_nav_link_hover').value;
      const thBg = $('theme_table_header_bg').value;
      const rowAlt = $('theme_table_row_alt').value;
      const rowHover = $('theme_table_row_hover').value;
      const btnBg = $('theme_button_bg').value;
      const btnHover = $('theme_button_hover_bg').value;
      const btnText = $('theme_button_text').value;

      const preview = $('theme-preview');
      const header = $('preview-header');
      const body = $('preview-body');
      const link = $('preview-link');
      const linkHover = $('preview-link-hover');
      const button = $('preview-button');
      const thRow = $('preview-th-row');
      const rowAltEl = $('preview-row-alt');
      const rowHoverEl = $('preview-row-hover');

      if (preview) preview.style.backgroundColor = bg;
      if (preview) preview.style.color = text;
      if (preview) {
        preview.style.borderRadius = radius;
        preview.style.borderWidth = borderWidth;
        preview.style.borderStyle = 'solid';
      }
      if (body) {
        body.style.backgroundColor = cardBg;
        body.style.color = text;
        body.style.padding = (0.75 * parseFloat(spacing || '1')) + 'rem';
      }
      if (header) {
        header.style.backgroundColor = headerBg;
        header.style.color = headerText;
        header.style.minHeight = headerHeight || '';
      }
      if (link) link.style.color = navLink;
      if (linkHover) linkHover.style.color = navLinkHover;
      if (button) {
        button.style.backgroundColor = btnBg;
        button.style.color = btnText;
      }
      if (thRow) thRow.style.color = text;
      if (rowAltEl) rowAltEl.style.color = text;
      if (rowHoverEl) rowHoverEl.style.color = text;
      if (thRow) thRow.style.backgroundColor = thBg;
      if (rowAltEl) rowAltEl.style.backgroundColor = rowAlt;
      if (rowHoverEl) rowHoverEl.style.backgroundColor = rowHover;

      // Simple visual cue for hover color
      rowHoverEl && (rowHoverEl.style.outline = '2px dashed ' + navLinkHover);
    }

    const presetSelect = $('theme_preset');
    if (presetSelect) {
      presetSelect.addEventListener('change', function () {
        const v = this.value;
        if (v === 'custom') return;
        applyPreset(v);
      });
    }

    const fontSelect = $('theme_font_family');
    if (fontSelect) {
      fontSelect.addEventListener('change', function () {
        if (presetSelect && presetSelect.value !== 'custom') {
          presetSelect.value = 'custom';
        }
        const selected = this.options[this.selectedIndex];
        const url = selected && selected.getAttribute('data-google-url') ? selected.getAttribute('data-google-url') : '';
        const urlField = $('theme_google_font_url');
        if (urlField) {
          urlField.value = url || '';
        }
        const preview = $('theme-preview');
        if (preview) preview.style.fontFamily = this.value;
      });
    }

    fieldIds.forEach((id) => {
      const el = $(id);
      if (el) {
        el.addEventListener('input', function () {
          // Mark preset as custom once the user starts tweaking
          if (presetSelect && presetSelect.value !== 'custom') {
            presetSelect.value = 'custom';
          }
          updatePreview();
        });
      }
    });

    // Initialize preview on load
    updatePreview();
    const previewInit = $('theme-preview');
    const fontInit = $('theme_font_family');
    if (previewInit && fontInit) {
      previewInit.style.fontFamily = fontInit.value;
    }
  })();
</script>

{% endblock %}
