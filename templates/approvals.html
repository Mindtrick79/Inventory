{% extends 'base.html' %}
{% block content %}

<div class="page-toolbar">
  <div class="page-toolbar__title">
    <h2>Approvals</h2>
    <div class="page-toolbar__subtitle">Approve or reject reorder requests and send vendor POs.</div>
  </div>
</div>

{% if not pending %}
  <div class="empty-state">
    <div class="empty-state__title">No pending reorder requests</div>
    <div class="empty-state__hint">When a request is submitted, it will appear here for approval.</div>
  </div>
{% else %}
  <form method="post">
    <div>
      <label for="user">Your Name (approver)</label>
      <input type="text" id="user" name="user" placeholder="Approver name">
    </div>
    <div>
      <label for="delivery_method">Delivery Method</label>
      <select id="delivery_method" name="delivery_method">
        <option value="SHIP">Ship to our address</option>
        <option value="PICKUP">Pickup (we will pick up)</option>
      </select>
    </div>
    <div>
      <label for="po_number">PO Number</label>
      <input type="text" id="po_number" name="po_number" placeholder="Enter PO #">
    </div>
    <div>
      <label for="pickup_by">Pickup By (optional)</label>
      <input type="text" id="pickup_by" name="pickup_by" placeholder="Employee name (for pickups)">
    </div>
    <div>
      <label for="needed_by">Needed By (optional)</label>
      <input type="date" id="needed_by" name="needed_by">
    </div>
    <div>
      <label for="delivery_notes">Delivery / Pickup Notes (optional)</label>
      <textarea id="delivery_notes" name="delivery_notes" rows="2" placeholder="e.g. Call when ready, ship ASAP, hold for pickup"></textarea>
    </div>
    <div>
      <label for="approval_notes">Notes to include in vendor email (optional)</label>
      <textarea id="approval_notes" name="approval_notes" rows="3"></textarea>
    </div>
    <div>
      <label for="internal_notes">Internal notes (only stored in log, not emailed)</label>
      <textarea id="internal_notes" name="internal_notes" rows="3"></textarea>
    </div>
    <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Timestamp</th>
          <th>Vendor</th>
          <th>User</th>
          <th>IP</th>
          <th>Items</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for row in pending %}
        <tr>
          <td>{{ row['Timestamp'] }}</td>
          <td>{{ row['Vendor'] }}</td>
          <td>{{ row['User'] }}</td>
          <td>{{ row['IP'] }}</td>
          <td>{{ row['Items'] }}</td>
          <td>{{ row['Status'] }}</td>
          <td>
            <button class="btn btn--primary btn--sm" type="submit" name="action" value="APPROVE" formaction="{{ url_for('approvals') }}?row={{ loop.index0 }}" formmethod="post" data-set-timestamp="{{ row['Timestamp'] }}" data-set-vendor="{{ row['Vendor'] }}">Approve</button>
            <button class="btn btn--danger btn--sm" type="submit" name="action" value="REJECT" formaction="{{ url_for('approvals') }}?row={{ loop.index0 }}" formmethod="post" data-set-timestamp="{{ row['Timestamp'] }}" data-set-vendor="{{ row['Vendor'] }}">Reject</button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    </div>
    <input type="hidden" name="timestamp" value="">
    <input type="hidden" name="vendor" value="">
  </form>

  <script>
    (function() {
      var form = document.querySelector('form');
      if (!form) return;
      form.addEventListener('click', function(e) {
        var btn = e.target;
        if (!btn || !btn.dataset) return;
        if (!btn.dataset.setTimestamp || !btn.dataset.setVendor) return;
        var ts = form.querySelector('input[name="timestamp"]');
        var v = form.querySelector('input[name="vendor"]');
        if (ts) ts.value = btn.dataset.setTimestamp;
        if (v) v.value = btn.dataset.setVendor;
      });
    })();
  </script>
{% endif %}
{% endblock %}
