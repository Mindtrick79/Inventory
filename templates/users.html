{% extends 'base.html' %}
{% block content %}
<h2>User Management</h2>
<p>Admin-only: manage application users, roles, and passwords.</p>

<section>
  <h3>Existing Users</h3>
  {% if users %}
  <table>
    <thead>
      <tr>
        <th>Username</th>
        <th>Role</th>
        <th>Name</th>
        <th>License #</th>
        <th>Photo</th>
        <th>Phone</th>
        <th>Email</th>
        <th>Default Truck</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for u in users %}
      <tr>
        <td>{{ u.username }}</td>
        <td>{{ u.role }}</td>
        <td>{{ u.display_name }}</td>
        <td>{{ u.license_number }}</td>
        <td>
          {% if u.photo_path %}
            <img src="{{ url_for('static', filename=u.photo_path) }}" alt="Photo" style="max-height: 48px; border-radius: 4px;">
          {% endif %}
        </td>
        <td>{{ u.phone }}</td>
        <td>{{ u.email }}</td>
        <td>{{ u.default_truck }}</td>
        <td>
          <button type="button" onclick="editUser('{{ u.username }}', '{{ u.role }}', '{{ u.display_name }}', '{{ u.license_number }}', '{{ u.phone }}', '{{ u.email }}', '{{ u.default_truck }}')">Edit</button>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
    <p>No users found.</p>
  {% endif %}
</section>

<section>
  <h3>Add / Update User</h3>
  <form method="post" enctype="multipart/form-data">
    <div>
      <label for="username">Username</label>
      <input type="text" id="username" name="username" required>
    </div>
    <div>
      <label for="display_name">Name</label>
      <input type="text" id="display_name" name="display_name" placeholder="Technician name">
    </div>
    <div>
      <label for="license_number">License #</label>
      <input type="text" id="license_number" name="license_number" placeholder="State license number">
    </div>
    <div>
      <label for="photo">Headshot Photo</label>
      <input type="file" id="photo" name="photo" accept="image/*">
    </div>
    <div>
      <label for="phone">Phone</label>
      <input type="text" id="phone" name="phone" placeholder="Cell phone">
    </div>
    <div>
      <label for="email">Email</label>
      <input type="text" id="email" name="email" placeholder="Optional">
    </div>
    <div>
      <label for="default_truck">Default Truck</label>
      <input type="text" id="default_truck" name="default_truck" placeholder="Truck 1, Truck 2, etc.">
    </div>
    <div>
      <label for="password">Password (leave blank to keep existing)</label>
      <input type="password" id="password" name="password">
    </div>
    <div>
      <label for="role">Role</label>
      <select id="role" name="role">
        {% for r in roles %}
          <option value="{{ r }}">{{ r }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <button type="submit">Save User</button>
    </div>
  </form>
</section>

<script>
  function editUser(username, role, displayName, licenseNumber, phone, email, defaultTruck) {
    var uInput = document.getElementById('username');
    var displayNameInput = document.getElementById('display_name');
    var licenseNumberInput = document.getElementById('license_number');
    var phoneInput = document.getElementById('phone');
    var emailInput = document.getElementById('email');
    var defaultTruckInput = document.getElementById('default_truck');
    var roleSelect = document.getElementById('role');
    if (uInput) {
      uInput.value = username;
    }
    if (displayNameInput) {
      displayNameInput.value = displayName || '';
    }
    if (licenseNumberInput) {
      licenseNumberInput.value = licenseNumber || '';
    }
    if (phoneInput) {
      phoneInput.value = phone || '';
    }
    if (emailInput) {
      emailInput.value = email || '';
    }
    if (defaultTruckInput) {
      defaultTruckInput.value = defaultTruck || '';
    }
    if (roleSelect) {
      for (var i = 0; i < roleSelect.options.length; i++) {
        if (roleSelect.options[i].value === role) {
          roleSelect.selectedIndex = i;
          break;
        }
      }
    }
    // Scroll form into view on smaller screens
    var form = document.querySelector('form');
    if (form && form.scrollIntoView) {
      form.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  }
</script>

{% endblock %}
