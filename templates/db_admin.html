{% extends 'base.html' %}
{% block content %}

<div class="page-toolbar">
  <div class="page-toolbar__title">
    <h2>Database</h2>
    <div class="page-toolbar__subtitle">Admin tools for initializing SQLite and importing from Excel.</div>
  </div>
</div>

{% if (backend or 'excel') == 'sqlite' and (total_rows or 0) == 0 %}
  <div class="form-card">
    <div class="form-card__title">SQLite health</div>
    <div style="opacity:0.9;">
      SQLite backend is enabled, but the database appears empty or not initialized.
      Use the migration checklist below to initialize and import.
    </div>
  </div>
{% endif %}

<div class="form-card">
  <div class="form-card__title">Actions</div>
  <form method="post" class="form-actions">
    <button class="btn btn--primary" type="submit" name="action" value="init">Initialize SQLite DB</button>
    <button class="btn btn--secondary" type="submit" name="action" value="import">Import Excel → SQLite</button>
    <a class="btn btn--secondary" href="{{ url_for('export_workbook_xlsx') }}">Download Workbook (Excel)</a>
    <a class="btn btn--secondary" href="{{ url_for('export_sqlite_xlsx') }}">SQLite → Excel (Round-trip)</a>
    <a class="btn btn--secondary" href="{{ url_for('export_snapshot_pdf') }}">Download Snapshot (PDF)</a>
  </form>
</div>

<div class="form-card">
  <div class="form-card__title">Backend mode</div>
  <div style="opacity:0.9; margin-bottom:0.5rem;">
    <strong>Current:</strong> {{ backend or 'excel' }}
  </div>
  <div style="opacity:0.8;">
    To run SQLite as the source of truth, set:
    <div style="margin-top:0.4rem; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; font-size:0.9rem; background: rgba(255,255,255,0.75); border:1px solid rgba(0,0,0,0.12); border-radius:6px; padding:0.6rem;">
      INVENTORY_BACKEND=sqlite
    </div>
  </div>
</div>

<div class="form-card">
  <div class="form-card__title">Migration checklist</div>
  <div style="opacity:0.85;">
    <div><strong>Step 1:</strong> Initialize SQLite DB</div>
    <div><strong>Step 2:</strong> Import Excel → SQLite</div>
    <div><strong>Step 3:</strong> Restart server with <span style="font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;">INVENTORY_BACKEND=sqlite</span></div>
    <div><strong>Step 4:</strong> Verify counts below and spot-check Products/Vendors/Reorder Log</div>
  </div>
</div>

<h3>Current SQLite DB</h3>
<p><strong>Path:</strong> {{ db_path }}</p>

{% if counts %}
  <div class="table-wrap">
  <table>
    <thead>
      <tr>
        <th>Table</th>
        <th>Rows</th>
      </tr>
    </thead>
    <tbody>
      {% for k, v in counts.items() %}
      <tr>
        <td>{{ k }}</td>
        <td>{{ v }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  </div>
{% else %}
  <div class="empty-state">
    <div class="empty-state__title">No database initialized yet</div>
    <div class="empty-state__hint">Initialize the DB and import from Excel to enable the SQLite backend.</div>
  </div>
{% endif %}

{% endblock %}
